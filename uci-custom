# Beware! This script will be in /rom/etc/uci-defaults/ as part of the image.
# Uncomment lines to apply:
#
# wlan_name="ImmortalWrt"
# wlan_password="12345678"
#
root_password="password"
lan_ip_address="10.0.0.1"
lan_netmask="255.255.255.0"
#
# pppoe_username=""
# pppoe_password=""

# log potential errors
exec >/tmp/setup.log 2>&1

if [ -n "$root_password" ]; then
  (echo "$root_password"; sleep 1; echo "$root_password") | passwd > /dev/null
fi

# Configure Loopback
uci set network.loopback=interface
uci set network.loopback.device='lo'
uci set network.loopback.proto='static'
uci set network.loopback.ipaddr='127.0.0.1'
uci set network.loopback.netmask='255.0.0.0'

# Configure Globals
uci set network.globals=globals
uci set network.globals.ula_prefix='fdca:75f0:16c4::/48'
uci set network.globals.packet_steering='1'

# Configure Bridge Device
uci set network.br_lan=device
uci set network.br_lan.name='br-lan'
uci set network.br_lan.type='bridge'
uci add_list network.br_lan.ports='eth0'
uci add_list network.br_lan.ports='eth2'
uci add_list network.br_lan.ports='eth3'

# Configure LAN
if [ -n "$lan_ip_address" ]; then
  uci set network.lan=interface
  uci set network.lan.device='br-lan'
  uci set network.lan.proto='static'
  uci set network.lan.ipaddr="$lan_ip_address"
  uci set network.lan.netmask="$lan_netmask"
  uci set network.lan.ip6assign='60'
fi

# Configure WAN
uci set network.wan=interface
uci set network.wan.device='eth1'
uci set network.wan.proto='dhcp'

# Configure WAN6
uci set network.wan6=interface
uci set network.wan6.device='eth1'
uci set network.wan6.proto='dhcpv6'

# Configure WLAN
# More options: https://openwrt.org/docs/guide-user/network/wifi/basic#wi-fi_interfaces
if [ -n "$wlan_name" -a -n "$wlan_password" -a ${#wlan_password} -ge 8 ]; then
  uci set wireless.@wifi-device[0].disabled='0'
  uci set wireless.@wifi-iface[0].disabled='0'
  uci set wireless.@wifi-iface[0].encryption='psk2'
  uci set wireless.@wifi-iface[0].ssid="$wlan_name"
  uci set wireless.@wifi-iface[0].key="$wlan_password"
  uci commit wireless
fi

# Configure PPPoE
# More options: https://openwrt.org/docs/guide-user/network/wan/wan_interface_protocols#protocol_pppoe_ppp_over_ethernet
if [ -n "$pppoe_username" -a -n "$pppoe_password" ]; then
  uci set network.wan.proto='pppoe'
  uci set network.wan.username="$pppoe_username"
  uci set network.wan.password="$pppoe_password"
fi

uci commit network

echo "All done!"
