# Beware! This script will be in /rom/etc/uci-defaults/ as part of the image.
# Uncomment lines to apply:
#
# wlan_name="ImmortalWrt"
# wlan_password="12345678"
#
root_password="password"
lan_ip_address="10.0.0.1"
#
# pppoe_username=""
# pppoe_password=""

# Log potential errors
exec >/tmp/setup.log 2>&1

# Set root password
if [ -n "$root_password" ]; then
  (echo "$root_password"; sleep 1; echo "$root_password") | passwd > /dev/null
fi

# Configure Network Interfaces
# Get list of physical interfaces (e.g., eth0, eth1, etc.)
interfaces=$(uci show network | grep -E 'network\.[a-zA-Z0-9]+\.ifname' | cut -d'=' -f2 | tr -d "'")
interface_array=($interfaces)
interface_count=${#interface_array[@]}

# Ensure there are at least two interfaces
if [ $interface_count -ge 2 ]; then
  # Configure second interface as WAN
  wan_ifname=${interface_array[1]}
  uci set network.wan=interface
  uci set network.wan.ifname="$wan_ifname"
  if [ -n "$pppoe_username" ] && [ -n "$pppoe_password" ]; then
    uci set network.wan.proto='pppoe'
    uci set network.wan.username="$pppoe_username"
    uci set network.wan.password="$pppoe_password"
  else
    uci set network.wan.proto='dhcp'
  fi

  # Configure remaining interfaces as LAN
  lan_ifnames=""
  for i in "${!interface_array[@]}"; do
    if [ $i -ne 1 ]; then
      lan_ifnames="$lan_ifnames ${interface_array[i]}"
    fi
  done
  uci set network.lan.ifname="$lan_ifnames"
  uci set network.lan.ipaddr="$lan_ip_address"
  uci set network.lan.netmask='255.255.255.0'
  uci set network.lan.proto='static'
else
  echo "Error: Fewer than two interfaces found, defaulting to original LAN config" >> /tmp/setup.log
  uci set network.lan.ipaddr="$lan_ip_address"
  uci set network.lan.netmask='255.255.255.0'
  uci set network.lan.proto='static'
fi
uci commit network

# Configure WLAN
# More options: https://openwrt.org/docs/guide-user/network/wifi/basic#wi-fi_interfaces
if [ -n "$wlan_name" ] && [ -n "$wlan_password" ] && [ ${#wlan_password} -ge 8 ]; then
  uci set wireless.@wifi-device[0].disabled='0'
  uci set wireless.@wifi-iface[0].disabled='0'
  uci set wireless.@wifi-iface[0].encryption='psk2'
  uci set wireless.@wifi-iface[0].ssid="$wlan_name"
  uci set wireless.@wifi-iface[0].key="$wlan_password"
  uci commit wireless
fi

echo "All done!"
